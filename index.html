<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dong Van Map - Business Edition</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .leaflet-div-icon { background: transparent !important; border: none !important; }
        .leaflet-marker-icon { will-change: transform; }

        .pin-wrapper { position: relative; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .pin-teardrop { width: 20px; height: 20px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); position: relative; z-index: 2; overflow: visible; }
        .pin-teardrop img { width: 14px !important; height: 14px !important; border-radius: 50%; transform: rotate(45deg); object-fit: cover !important; background-color: #f3f4f6; display: block; }
        .pin-teardrop span, .pin-teardrop i { transform: rotate(45deg); font-size: 10px; font-weight: 800; line-height: 1; }
        .pin-label { position: absolute; top: 24px; left: 50%; transform: translateX(-50%); font-size: 8px; font-weight: 700; color: white; white-space: nowrap; text-shadow: 1px 1px 2px #000, -1px -1px 2px #000, 1px -1px 2px #000, -1px 1px 2px #000; z-index: 10; pointer-events: none; text-align: center; width: auto; max-width: 100px; overflow: hidden; text-overflow: ellipsis; }
        .pin-normal .pin-teardrop { background: #1f2937; border: 1px solid #facc15; }
        .pin-checkin .pin-teardrop { background: #fff; border: 1px solid #ef4444; }
        .pin-tour-step .pin-teardrop { background: #ef4444; border: 1px solid #fff; color: white; }
        .pin-vip { z-index: 1000 !important; animation: float 3s ease-in-out infinite; }
        .pin-vip .pin-teardrop { background: linear-gradient(135deg, #1f2937 0%, #000 100%); border: 1px solid #fbbf24; animation: vip-border-pulse 1.5s infinite alternate; box-shadow: 0 0 4px rgba(251, 191, 36, 0.6); }
        @keyframes vip-border-pulse { 0% { border-color: #fbbf24; box-shadow: 0 0 2px #fbbf24; } 100% { border-color: #fff; box-shadow: 0 0 6px #f59e0b; } }
        .pin-vip::after { content: ''; position: absolute; bottom: -2px; width: 10px; height: 4px; background: rgba(251, 191, 36, 0.5); border-radius: 50%; animation: ripple 1.5s infinite; z-index: 1; }
        .pin-vip::before { content: 'üëë'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 8px; z-index: 10; animation: bounce 2s infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }
        @keyframes ripple { 0% { transform: scale(0.5); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -2px); } }

        .user-marker-container { position: relative; width: 20px; height: 20px; }
        .user-dot { width: 14px; height: 14px; background: #3b82f6; border: 2px solid white; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .user-pulse { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(59, 130, 246, 0.4); border-radius: 50%; z-index: 1; animation: pulse-blue 2s infinite; pointer-events: none; }
        @keyframes pulse-blue { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        .snake-road-path { stroke-dasharray: 12, 24; animation: snakeFlow 1s linear infinite; will-change: stroke-dashoffset; }
        @keyframes snakeFlow { from { stroke-dashoffset: 36; } to { stroke-dashoffset: 0; } }
        .glass-panel { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .text-gold { background: linear-gradient(to right, #fcd34d, #f59e0b, #fcd34d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .luxury-border { border: 1px solid #eab308; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tag-btn.active { background: #eab308; color: black; border-color: #eab308; font-weight: bold; }
        .guide-btn { position: relative; overflow: hidden; transition: all 0.3s; }
        .guide-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #fbbf24); animation: btn-border-top 2s linear infinite; }
        .guide-btn::after { content: ''; position: absolute; bottom: 0; right: -100%; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #fbbf24); animation: btn-border-bottom 2s linear infinite; }
        @keyframes btn-border-top { 0% { left: -100%; } 50%, 100% { left: 100%; } }
        @keyframes btn-border-bottom { 0% { right: 100%; } 50%, 100% { right: -100%; } }

        /* --- STYLE CHO SLIDER TOUR (CAROUSEL) --- */
        #tour-slider { scroll-behavior: smooth; }
        .tour-slide-card {
            min-width: 220px; height: 130px;
            border-radius: 12px; position: relative; overflow: hidden; flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.2s, border-color 0.2s; cursor: pointer;
            background: #0f172a;
        }
        .tour-slide-card:active { transform: scale(0.95); }
        .tour-slide-card.active { border: 2px solid #fbbf24; transform: translateY(-5px); }
        .tour-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: opacity 0.3s; }
        .tour-content { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden text-white font-sans">

    <div id="map" class="absolute inset-0 z-0 bg-gray-900"></div>

    <div class="absolute top-0 left-0 right-0 z-[1000] pointer-events-none flex flex-col gap-2">
        <div class="p-4 pb-0 flex justify-between items-start">
            <div class="pointer-events-auto glass-panel px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg border-b border-yellow-500/50">
                <span class="text-lg animate-pulse">‚õ∞Ô∏è</span>
                <div>
                    <div class="text-[9px] text-gray-400 uppercase tracking-widest">ƒê·ªìng VƒÉn</div>
                    <div class="text-orange-400 font-bold text-xs" id="user-points">0 PTS</div>
                </div>
            </div>
            <div class="flex gap-2 pointer-events-auto">
                <button onclick="window.toggleGPS()" id="btn-gps" class="w-9 h-9 glass-panel rounded-full flex items-center justify-center text-gray-300 shadow-lg active:scale-95 transition-all border border-white/10"><i data-lucide="locate" width="18"></i></button>
                <button onclick="window.clearRoute()" id="btn-clear-route" class="hidden w-9 h-9 glass-panel bg-red-900/50 rounded-full flex items-center justify-center text-red-400 shadow-lg active:scale-95 transition-all border border-red-500/30"><i data-lucide="trash-2" width="18"></i></button>
                <button onclick="window.openRewards()" class="w-9 h-9 glass-panel rounded-full flex items-center justify-center text-orange-400 shadow-lg active:scale-95 transition-all border border-white/10"><i data-lucide="gift" width="18"></i></button>
            </div>
        </div>
        <div class="flex gap-2 pointer-events-auto justify-center px-4 overflow-x-auto hide-scrollbar">
            <button onclick="window.openCategory('checkin')" class="guide-btn glass-panel px-3 py-2 rounded-lg flex items-center gap-1.5 shadow-lg active:scale-95 border border-yellow-500/20 shrink-0">
                <i data-lucide="map" class="text-blue-400" width="14"></i>
                <span class="text-[10px] font-bold uppercase text-blue-100">ƒêi·ªÉm du l·ªãch</span>
            </button>
            <button onclick="window.openCategory('food')" class="guide-btn glass-panel px-3 py-2 rounded-lg flex items-center gap-1.5 shadow-lg active:scale-95 border border-yellow-500/20 shrink-0">
                <i data-lucide="utensils" class="text-red-400" width="14"></i>
                <span class="text-[10px] font-bold uppercase text-red-100">·∫®m th·ª±c</span>
            </button>
            <button onclick="window.openCategory('hotel')" class="guide-btn glass-panel px-3 py-2 rounded-lg flex items-center gap-1.5 shadow-lg active:scale-95 border border-yellow-500/20 shrink-0">
                <i data-lucide="bed" class="text-purple-400" width="14"></i>
                <span class="text-[10px] font-bold uppercase text-purple-100">L∆∞u tr√∫</span>
            </button>
        </div>
        <div id="filter-bar" class="hidden pointer-events-auto px-4">
            <div class="glass-panel p-2 rounded-lg flex gap-2 overflow-x-auto hide-scrollbar border-t border-yellow-500/30" id="filter-tags">
                </div>
            <button onclick="closeFilter()" class="mx-auto mt-1 bg-black/50 text-[9px] px-2 py-0.5 rounded-full text-gray-400 flex items-center gap-1 hover:text-white"><i data-lucide="x" width="8"></i> ƒê√≥ng l·ªçc</button>
        </div>
    </div>

    <div id="tour-slider" class="absolute bottom-6 left-0 right-0 z-[1500] pointer-events-auto px-4 overflow-x-auto hide-scrollbar flex gap-3 hidden pl-4 pr-10 pb-4">
        </div>

    <div id="route-loader" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[4000] bg-black/80 px-4 py-3 rounded-xl flex flex-col items-center hidden backdrop-blur">
        <div class="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin mb-2"></div>
        <span class="text-[10px] uppercase text-yellow-500 font-bold">ƒêang t·∫£i...</span>
    </div>

    <div id="popup-detail" class="absolute bottom-4 left-3 right-3 z-[2000] pointer-events-none flex justify-center hidden">
        <div class="w-full max-w-sm bg-slate-900/95 backdrop-blur-xl rounded-xl shadow-2xl pointer-events-auto slide-up overflow-hidden flex flex-col max-h-[60vh] luxury-border">
            
            <div class="relative shrink-0 h-40 w-full bg-black overflow-hidden shadow-md">
                <img id="loc-img" src="" class="w-full h-full object-cover object-center"/>
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                <button onclick="window.closePopup()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full hover:bg-black/80 transition-colors backdrop-blur-sm">
                    <i data-lucide="x" width="14"></i>
                </button>
                <div id="vip-badge" class="hidden absolute top-2 left-2 bg-yellow-400 text-black text-[9px] font-bold px-1.5 py-0.5 rounded shadow-lg flex items-center gap-1">
                    <i data-lucide="crown" width="10"></i> ƒê·ªêI T√ÅC VIP
                </div>
            </div>

            <div class="flex flex-col pt-2 px-4 pb-3 overflow-y-auto custom-scrollbar">
                <h3 id="loc-name" class="text-lg font-black text-gold uppercase tracking-wide leading-tight mb-0.5">---</h3>
                <div class="flex items-center justify-between mb-2">
                    <div class="flex gap-1.5 text-slate-400 text-[10px] items-center">
                        <i data-lucide="map-pin" class="text-red-500 shrink-0" width="10"></i> 
                        <span id="loc-address" class="line-clamp-1">---</span>
                    </div>
                </div>

                <div id="route-info" class="flex gap-2 mb-2 bg-slate-800/80 p-1.5 rounded border border-yellow-500/20 hidden">
                    <div class="flex-1 flex flex-col items-center border-r border-white/10">
                        <span class="text-[9px] text-gray-400 uppercase">Kho·∫£ng c√°ch</span>
                        <span id="loc-distance" class="text-yellow-400 font-bold text-xs">...</span>
                    </div>
                    <div class="flex-1 flex flex-col items-center">
                        <span class="text-[9px] text-gray-400 uppercase">Th·ªùi gian</span>
                        <span id="loc-duration" class="text-yellow-400 font-bold text-xs">...</span>
                    </div>
                </div>

                <div id="gallery-btn-container" class="mb-2 hidden"></div>

                <div class="mb-2">
                     <button id="btn-main-contact" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-md font-bold text-[12px] flex items-center justify-center gap-2 shadow active:scale-95 transition border border-green-400">
                        <i data-lucide="phone-call" width="16"></i> LI√äN H·ªÜ NGAY
                    </button>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="window.fitRoute()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-1.5 rounded-md font-bold text-[10px] flex items-center justify-center gap-1 shadow active:scale-95 border border-white/10">
                        <i data-lucide="map" width="12"></i> XEM B·∫¢N ƒê·ªí
                    </button>
                    <button onclick="window.checkIn()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-1.5 rounded-md font-bold text-[10px] flex items-center justify-center gap-1 shadow active:scale-95 border border-white/10">
                        <i data-lucide="scan" width="12"></i> CHECK-IN
                    </button>
                </div>

                <p id="loc-desc" class="text-xs text-gray-300 mb-2 text-justify leading-snug border-l-2 border-yellow-500/50 pl-2 opacity-90">---</p>
                
                <div id="service-box" class="bg-slate-800/50 p-2 rounded border border-yellow-500/10">
                    <div id="loc-menu" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-gallery" class="fixed inset-0 z-[5000] bg-black/95 flex flex-col hidden">
        <div class="p-4 flex justify-between items-center border-b border-white/10 bg-slate-900">
            <h3 id="gal-title" class="text-gold font-bold uppercase text-sm">H√¨nh ·∫£nh</h3>
            <button onclick="document.getElementById('modal-gallery').classList.add('hidden')" class="text-white"><i data-lucide="x" width="24"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 items-center justify-start" id="gal-content">
            </div>
    </div>
    
    <div id="modal-contact-choice" class="fixed inset-0 z-[6000] bg-black/90 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-yellow-500/50 rounded-xl p-4 w-full max-w-xs text-center shadow-2xl slide-up">
            <h3 class="text-gold font-bold text-sm uppercase mb-4 tracking-wider">Ch·ªçn c√°ch li√™n h·ªá</h3>
            <div class="grid grid-cols-2 gap-3">
                <button id="btn-choice-call" class="bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold text-xs flex flex-col items-center gap-1 active:scale-95 transition">
                    <i data-lucide="phone" width="20"></i> G·ªçi tr·ª±c ti·∫øp
                </button>
                <button id="btn-choice-zalo" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold text-xs flex flex-col items-center gap-1 active:scale-95 transition">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1200px-Icon_of_Zalo.svg.png" width="20" class="rounded bg-white p-0.5"> 
                    Chat Zalo
                </button>
            </div>
            <button onclick="window.closeContactModal()" class="mt-4 text-gray-400 text-[10px] hover:text-white border-b border-transparent hover:border-gray-400 transition">ƒê√≥ng</button>
        </div>
    </div>

    <div id="modal-rewards" class="fixed inset-0 z-[3000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-sm glass-panel rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[80vh] luxury-border">
            <div class="bg-slate-800 p-3 text-center border-b border-white/10 relative">
                <button onclick="window.closeRewards()" class="absolute top-3 right-3 text-slate-500 hover:text-white"><i data-lucide="x" width="18"></i></button>
                <h2 class="text-base font-bold text-gold uppercase">Kho Qu√†</h2>
            </div>
            <div class="p-4 space-y-2 overflow-y-auto" id="rewards-list"></div>
        </div>
    </div>
    <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-xl z-[4000] font-bold text-xs border border-yellow-500 hidden whitespace-nowrap flex items-center gap-2">
        <i data-lucide="bell" width="14" class="text-yellow-500"></i> <span id="toast-msg">...</span>
    </div>
    <script type="module">
        const firebaseConfig = { apiKey: "AIzaSyAupPfv0VdxqpFiVFlw5IhMSHIMcR-EiGg", authDomain: "dongvanmap.firebaseapp.com", projectId: "dongvanmap", storageBucket: "dongvanmap.firebasestorage.app", messagingSenderId: "453876053390", appId: "1:453876053390:web:f96ee558f6f9fede1ee0df" };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let map, userMarker, watchId, markersLayer = [];
        let userPos = { lat: 23.27833, lng: 105.36154 }; 
        let locations = [];
        let tours = []; 
        let isTracking = false;
        
        let currentFilterType = null; 
        let currentFilterTag = null;
        let lastMapUpdatePos = null; 
        const MIN_UPDATE_DISTANCE = 15; 
        const CACHE_KEY = 'dongvan_locations_v9_business';

        let db; 

        window.addEventListener('load', () => {
            initMap();
            loadDataSmart();
            startGPS();
        });

        function initMap() {
            if(document.getElementById('map')._leaflet_id) return;
            map = L.map('map', { zoomControl: false, tap: false, preferCanvas: true }).setView([userPos.lat, userPos.lng], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
            const uIcon = L.divIcon({ className: '', html: '<div class="user-marker-container"><div class="user-pulse"></div><div class="user-dot"></div></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
            userMarker = L.marker([userPos.lat, userPos.lng], { icon: uIcon, zIndexOffset: 2000 }).addTo(map);
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.on('locationfound', (e) => { userPos = e.latlng; userMarker.setLatLng(e.latlng); isTracking = true; updateGPSBtn(true); });
            map.on('dragstart', () => { if(isTracking) disableTracking("ƒê√£ t·∫Øt t·ª± ƒë·ªông theo d√µi"); });
            map.on('click', () => { window.closePopup(); window.closeContactModal(); }); 
            lucide.createIcons();
        }

        function startGPS() {
            if (!navigator.geolocation) return;
            const geoOptions = { enableHighAccuracy: true, maximumAge: 10000, timeout: 10000 };
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;
                    userPos = { lat: latitude, lng: longitude };
                    if(userMarker) userMarker.setLatLng([latitude, longitude]);
                    if (isTracking && map) {
                        if (!lastMapUpdatePos) { map.flyTo([latitude, longitude], 17, { animate: true, duration: 1.5 }); lastMapUpdatePos = userPos; } 
                        else { const dist = map.distance([lastMapUpdatePos.lat, lastMapUpdatePos.lng], [latitude, longitude]); if (dist > MIN_UPDATE_DISTANCE) { map.panTo([latitude, longitude], { animate: true, duration: 0.5 }); lastMapUpdatePos = userPos; } }
                    }
                },
                (err) => console.warn("GPS Waiting...", err), geoOptions
            );
        }

        async function loadDataSmart() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) { try { const d = JSON.parse(cached); locations = d.locations||[]; tours = d.tours||[]; renderMarkers(); } catch(e) {} }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const locSnap = await getDocs(collection(db, "locations"));
                if (!locSnap.empty) locations = locSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const tourSnap = await getDocs(collection(db, "tours"));
                if (!tourSnap.empty) tours = tourSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem(CACHE_KEY, JSON.stringify({ locations, tours }));
                renderMarkers();
            } catch (e) { console.error(e); }
        }

        function renderMarkers() {
            markersLayer.forEach(m => map.removeLayer(m));
            markersLayer = [];

            locations.forEach(loc => {
                if (currentFilterType && loc.type !== currentFilterType) return;
                if (currentFilterTag) {
                    if (currentFilterType === 'checkin') { if (loc.name !== currentFilterTag) return; } 
                    else { if (!loc.tags || !loc.tags.includes(currentFilterTag)) return; }
                }

                const score = loc.score || 0;
                let wrapperClass = "pin-wrapper";
                let pinClass = "pin-normal"; 
                let innerContent = "";

                if (loc.type === 'checkin') {
                    pinClass = "pin-checkin";
                    innerContent = loc.image ? `<img src="${loc.image}">` : '<i data-lucide="camera" width="16"></i>';
                } else {
                    if (score <= 0) return; 
                    const emojiMap = { 'food': 'üçú', 'hotel': 'üõèÔ∏è', 'cafe': '‚òï', 'shopping': 'üõçÔ∏è', 'rescue': 'üõ†Ô∏è' };
                    innerContent = loc.image ? `<img src="${loc.image}">` : (emojiMap[loc.type] || 'üìç');
                    if (score >= 1000) wrapperClass += " pin-vip";
                }

                const html = `<div class="${wrapperClass} ${pinClass}"><div class="pin-teardrop">${innerContent}</div><div class="pin-label">${loc.name}</div></div>`;
                const icon = L.divIcon({ className: '', html: html, iconSize: [24, 24], iconAnchor: [12, 30] });
                const marker = L.marker([loc.lat, loc.lng], { icon: icon }).addTo(map);
                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); openPopup(loc); });
                markersLayer.push(marker);
            });
            lucide.createIcons();
        }

        window.openCategory = function(type) {
            currentFilterType = type; currentFilterTag = null; renderMarkers();
            
            const tourSlider = document.getElementById('tour-slider');
            // N·∫øu l√† m·ª•c Checkin -> Hi·ªán Tour Slider
            if (type === 'checkin') { renderTourSlider(); tourSlider.classList.remove('hidden'); } 
            else { tourSlider.classList.add('hidden'); }

            // Filter logic c≈©
            const filterBar = document.getElementById('filter-bar');
            const relatedLocs = locations.filter(l => l.type === type);
            let filterItems = new Set();
            if (type === 'checkin') { relatedLocs.forEach(l => filterItems.add(l.name)); } 
            else { relatedLocs.forEach(l => { if(l.tags) l.tags.forEach(t => filterItems.add(t)); }); }
            
            const filterTags = document.getElementById('filter-tags');
            if (filterItems.size > 0) {
                filterBar.classList.remove('hidden');
                let html = `<button onclick="window.filterByTag(null)" class="tag-btn active glass-panel px-3 py-1 rounded text-[10px] whitespace-nowrap border border-white/20">T·∫•t c·∫£</button>`;
                filterItems.forEach(item => { html += `<button onclick="window.filterByTag('${item}')" class="tag-btn glass-panel px-3 py-1 rounded text-[10px] whitespace-nowrap border border-white/20 text-gray-300 hover:text-white">${item}</button>`; });
                filterTags.innerHTML = html;
            } else { filterBar.classList.add('hidden'); }

            if (relatedLocs.length > 0) {
                const group = new L.featureGroup(markersLayer);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        function renderTourSlider() {
            const slider = document.getElementById('tour-slider');
            slider.innerHTML = ''; 
            if (tours.length === 0) { slider.classList.add('hidden'); return; }

            tours.forEach(tour => {
                let bgImage = "https://via.placeholder.com/200x120?text=Tour";
                if(tour.points && tour.points.length > 0) {
                    const firstLoc = locations.find(l => l.id === tour.points[0]);
                    if(firstLoc && firstLoc.image) bgImage = firstLoc.image;
                }

                const card = document.createElement('div');
                card.className = "tour-slide-card";
                card.onclick = () => {
                    document.querySelectorAll('.tour-slide-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    window.showTourDetails(tour.id); // G·ªçi h√†m hi·ªÉn th·ªã chi ti·∫øt thay v√¨ v·∫Ω ƒë∆∞·ªùng
                };

                card.innerHTML = `
                    <img src="${bgImage}" class="tour-bg">
                    <div class="tour-content">
                        <div class="text-[10px] text-yellow-400 font-bold uppercase tracking-wider mb-0.5"><i data-lucide="flag" width="10" class="inline"></i> Tour ƒê·ªÅ Xu·∫•t</div>
                        <div class="text-sm font-bold text-white leading-tight mb-1">${tour.name}</div>
                        <div class="flex items-center gap-2 text-[9px] text-gray-300"><span>üïí ${tour.points?.length || 0} ƒëi·ªÉm</span></div>
                    </div>`;
                slider.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- NEW: HI·ªÇN TH·ªä CHI TI·∫æT TOUR & MARKERS (KH√îNG V·∫º ƒê∆Ø·ªúNG) ---
        window.showTourDetails = function(tourId) {
            const tour = tours.find(t => t.id === tourId);
            if (!tour || !tour.points || tour.points.length === 0) return;

            // 1. X√≥a Markers c≈© & V·∫Ω Markers theo Tour (c√≥ s·ªë th·ª© t·ª±)
            markersLayer.forEach(m => map.removeLayer(m));
            markersLayer = [];

            let listHtml = '<div class="space-y-3 mt-2">';
            
            tour.points.forEach((pid, index) => {
                const loc = locations.find(l => l.id === pid);
                if (loc) {
                    // Marker tr√™n b·∫£n ƒë·ªì
                    const html = `
                        <div class="pin-wrapper pin-tour-step">
                            <div class="pin-teardrop">
                                <span class="text-white font-bold" style="transform: rotate(45deg)">${index + 1}</span>
                            </div>
                            <div class="pin-label">${loc.name}</div>
                        </div>`;
                    const icon = L.divIcon({ className: '', html: html, iconSize: [24, 24], iconAnchor: [12, 30] });
                    const marker = L.marker([loc.lat, loc.lng], { icon: icon }).addTo(map);
                    marker.on('click', () => openPopup(loc)); 
                    markersLayer.push(marker);
                    
                    // T·∫°o n·ªôi dung List (Timeline) ƒë·∫πp m·∫Øt
                    listHtml += `
                        <div class="flex items-start gap-3 relative group">
                            ${index !== tour.points.length - 1 ? '<div class="absolute left-[11px] top-6 bottom-[-14px] w-[2px] bg-slate-700/50"></div>' : ''}
                            <div class="w-6 h-6 flex-shrink-0 bg-red-600 text-white rounded-full flex items-center justify-center text-[10px] font-bold shadow-lg border border-red-400 z-10">
                                ${index + 1}
                            </div>
                            <div class="flex-1 bg-slate-800/60 rounded-lg p-2.5 border border-white/5 hover:bg-slate-700/80 hover:border-yellow-500/30 transition cursor-pointer active:scale-95" onclick="window.openPopupById('${loc.id}')">
                                <div class="flex justify-between items-start gap-2">
                                    <h4 class="text-xs font-bold text-gray-100 leading-tight">${loc.name}</h4>
                                    <i data-lucide="chevron-right" class="text-gray-600" width="12"></i>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1 line-clamp-1 flex items-center gap-1">
                                    <i data-lucide="map-pin" width="8"></i> ${loc.address || 'ƒê·ªìng VƒÉn'}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            listHtml += '</div>';

            // 2. Fit Map ƒë·ªÉ th·∫•y to√†n b·ªô ƒëi·ªÉm
            if (markersLayer.length > 0) {
                const group = new L.featureGroup(markersLayer);
                map.fitBounds(group.getBounds(), { padding: [50, 200] }); // Padding d∆∞·ªõi l·ªõn ƒë·ªÉ tr√°nh che b·ªüi popup
            }

            // 3. Hi·ªÉn th·ªã Popup ch·ª©a danh s√°ch
            const p = document.getElementById('popup-detail');
            p.classList.remove('hidden', 'slide-up');
            void p.offsetWidth; p.classList.add('slide-up');

            document.getElementById('loc-name').innerText = tour.name;
            document.getElementById('loc-address').innerHTML = `<span class="text-yellow-400 font-bold">‚òÖ L·ªô tr√¨nh ${tour.points.length} ƒëi·ªÉm tham quan</span>`;
            
            // L·∫•y ·∫£nh ƒëi·ªÉm ƒë·∫ßu ti√™n
            const firstLoc = locations.find(l => l.id === tour.points[0]);
            document.getElementById('loc-img').src = firstLoc ? (firstLoc.image || "https://via.placeholder.com/400x200") : "https://via.placeholder.com/400x200";
            
            document.getElementById('loc-desc').innerText = tour.desc || "L·ªô tr√¨nh tham quan h·∫•p d·∫´n.";

            // Inject List HTML v√†o khu v·ª±c n·ªôi dung
            document.getElementById('loc-menu').innerHTML = listHtml;

            // ·∫®n c√°c n√∫t kh√¥ng c·∫ßn thi·∫øt
            document.getElementById('vip-badge').classList.add('hidden');
            document.getElementById('btn-main-contact').classList.add('hidden');
            document.getElementById('gallery-btn-container').classList.add('hidden');
            document.getElementById('route-info').classList.add('hidden');
            document.getElementById('btn-clear-route').classList.remove('hidden'); // N√∫t ƒë√≥ng ch·∫ø ƒë·ªô Tour
            
            lucide.createIcons();
            showToast(`ƒêang xem: ${tour.name}`);
        }

        // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
        window.openPopup = function(loc) {
            window.clearRoute(); 
            const p = document.getElementById('popup-detail');
            p.classList.remove('hidden', 'slide-up'); void p.offsetWidth; p.classList.add('slide-up');
            document.getElementById('loc-name').innerText = loc.name;
            document.getElementById('loc-address').innerText = loc.address || "ƒê·ªìng VƒÉn, H√† Giang";
            document.getElementById('loc-desc').innerText = loc.desc || "ƒêang c·∫≠p nh·∫≠t...";
            document.getElementById('loc-img').src = loc.image || "https://via.placeholder.com/400x200";
            const menuHtml = (loc.menu || []).slice(0,3).map(i => `<div class="text-[10px] text-slate-300 border-b border-white/5 py-0.5 pl-1">‚Ä¢ ${i}</div>`).join('');
            document.getElementById('loc-menu').innerHTML = menuHtml || '<div class="text-[10px] text-gray-500 italic">Ch∆∞a c√≥ th√¥ng tin d·ªãch v·ª•</div>';
            const vipBadge = document.getElementById('vip-badge');
            if ((loc.score || 0) >= 1000) vipBadge.classList.remove('hidden'); else vipBadge.classList.add('hidden');
            const btnContainer = document.getElementById('gallery-btn-container');
            if (loc.type === 'food' || loc.type === 'cafe') {
                btnContainer.innerHTML = `<button onclick="window.openGallery('${loc.id}', 'menu')" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-1.5 rounded-md font-bold text-[10px] flex items-center justify-center gap-1 shadow border border-orange-400"><i data-lucide="book-open" width="12"></i> XEM MENU</button>`;
                btnContainer.classList.remove('hidden');
            } else if (loc.type === 'hotel') {
                btnContainer.innerHTML = `<button onclick="window.openGallery('${loc.id}', 'room')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-1.5 rounded-md font-bold text-[10px] flex items-center justify-center gap-1 shadow border border-blue-400"><i data-lucide="image" width="12"></i> XEM ·∫¢NH PH√íNG</button>`;
                btnContainer.classList.remove('hidden');
            } else { btnContainer.classList.add('hidden'); }
            lucide.createIcons();
            const btnMain = document.getElementById('btn-main-contact');
            if (loc.phone) { btnMain.classList.remove('hidden'); btnMain.onclick = () => window.openContactModal(loc); } 
            else { btnMain.classList.add('hidden'); }
            const targetLat = loc.lat - 0.0020; map.flyTo([targetLat, loc.lng], 17, { duration: 1 });
        }
        
        window.openGallery = function(locId, type) {
            const loc = locations.find(l => l.id === locId); if (!loc) return;
            const modal = document.getElementById('modal-gallery');
            const title = document.getElementById('gal-title'); const content = document.getElementById('gal-content');
            title.innerText = type === 'menu' ? "Menu Th·ª±c ƒê∆°n" : "H√¨nh ·∫¢nh Ph√≤ng";
            content.innerHTML = '';
            const images = loc.gallery && loc.gallery.length > 0 ? loc.gallery : [loc.image]; 
            if (images.length > 0 && images[0]) { images.forEach(imgUrl => { const img = document.createElement('img'); img.src = imgUrl; img.className = "w-full rounded-lg shadow-lg border border-white/20"; content.appendChild(img); }); } else { content.innerHTML = '<div class="text-gray-400 italic text-xs mt-10">Ch∆∞a c√≥ h√¨nh ·∫£nh c·∫≠p nh·∫≠t.</div>'; }
            modal.classList.remove('hidden');
        }
        window.openPopupById = function(id) { const loc = locations.find(l => l.id === id); if(loc) openPopup(loc); }
        window.closePopup = function() { document.getElementById('popup-detail').classList.add('hidden'); }
        
        // Reset v·ªÅ ch·∫ø ƒë·ªô b√¨nh th∆∞·ªùng (x√≥a Tour mode)
        window.clearRoute = function() { 
            document.getElementById('btn-clear-route').classList.add('hidden'); 
            // Reset markers v·ªÅ m·∫∑c ƒë·ªãnh
            if (currentFilterType) {
                renderMarkers(); // V·∫Ω l·∫°i markers theo filter hi·ªán t·∫°i
            }
        }
        
        window.openContactModal = function(loc) { const m = document.getElementById('modal-contact-choice'); m.classList.remove('hidden'); m.classList.add('flex'); document.getElementById('btn-choice-call').onclick = () => { contactBusiness(loc, 'call'); window.closeContactModal(); }; document.getElementById('btn-choice-zalo').onclick = () => { contactBusiness(loc, 'zalo'); window.closeContactModal(); }; }
        window.closeContactModal = function() { const m = document.getElementById('modal-contact-choice'); m.classList.add('hidden'); m.classList.remove('flex'); }
        async function contactBusiness(loc, method) { if (method === 'call') window.location.href = `tel:${loc.phone}`; else if (method === 'zalo') { const cleanPhone = loc.phone.replace(/^0/, '84').replace(/\D/g,''); window.open(`https://zalo.me/${cleanPhone}`, '_blank'); } }
        
        window.closeFilter = function() {
            document.getElementById('filter-bar').classList.add('hidden');
            document.getElementById('tour-slider').classList.add('hidden');
            window.clearRoute();
            currentFilterType = null; currentFilterTag = null; 
            renderMarkers(); 
            map.setZoom(16);
        }
        window.filterByTag = function(tag) {
            currentFilterTag = tag; renderMarkers(); 
            const filterTags = document.getElementById('filter-tags');
            if (tag) {
                let filteredLocs = locations.filter(l => { if (currentFilterType === 'checkin') return l.name === tag; return l.type === currentFilterType && l.tags && l.tags.includes(tag); });
                filteredLocs.sort((a, b) => (b.score || 0) - (a.score || 0));
                if (filteredLocs.length > 0) {
                    let html = `<button onclick="window.openCategory('${currentFilterType}')" class="tag-btn glass-panel px-3 py-1 rounded text-[10px] whitespace-nowrap border border-white/20 text-yellow-500 font-bold"><i data-lucide="arrow-left" width="10" class="inline"></i> Quay l·∫°i</button>`;
                    filteredLocs.forEach(l => {
                        const isVip = (l.score || 0) >= 1000;
                        const btnClass = isVip ? "guide-btn glass-panel px-3 py-1.5 rounded h-auto whitespace-normal leading-tight text-left border border-yellow-500/50 text-yellow-400 font-bold shadow-lg flex items-center gap-1.5 min-w-[120px]" : "tag-btn glass-panel px-3 py-1 rounded text-[10px] whitespace-nowrap border border-white/20 text-gray-300 hover:text-white";
                        const content = isVip ? `<i data-lucide="crown" width="12" class="shrink-0"></i> <span>${l.name}</span>` : l.name;
                        html += `<button onclick="window.openPopupById('${l.id}')" class="${btnClass}">${content}</button>`;
                    });
                    filterTags.innerHTML = html; lucide.createIcons();
                }
                const group = new L.featureGroup(markersLayer); if (markersLayer.length > 0) map.fitBounds(group.getBounds(), { padding: [50, 50] });
            } else { window.openCategory(currentFilterType); }
        }
        
        window.toggleGPS = function() { isTracking ? disableTracking("ƒê√£ t·∫Øt theo d√µi") : enableTracking(); }
        function enableTracking() { isTracking = true; lastMapUpdatePos = null; updateGPSBtn(true); map.flyTo([userPos.lat, userPos.lng], 17); showToast("ƒêang theo d√µi v·ªã tr√≠"); }
        function disableTracking(msg) { isTracking = false; updateGPSBtn(false); if(msg) showToast(msg); }
        function updateGPSBtn(active) { const btn = document.getElementById('btn-gps'); active ? btn.classList.add('bg-green-600', 'text-white') : btn.classList.remove('bg-green-600', 'text-white'); }
        window.fitRoute = function() { if(markersLayer.length > 0) { const group = new L.featureGroup(markersLayer); map.fitBounds(group.getBounds(), { padding: [50, 50] }); } }
        window.openRewards = function() { document.getElementById('modal-rewards').classList.remove('hidden'); }
        window.closeRewards = function() { document.getElementById('modal-rewards').classList.add('hidden'); }
        window.checkIn = function() { showToast("Check-in +10 ƒëi·ªÉm!"); }
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
    </script>
</body>
</html>
